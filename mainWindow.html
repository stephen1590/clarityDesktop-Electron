<html lang="en">

<head>
    <title>Clarity Wrapper</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="css/tabs.css">
    <link rel="stylesheet" href="css/styles.css">
    <script type="text/javascript" src='js/swaggerUtils.js'></script>
    <script type="text/javascript" src='js/builderUtils.js'></script>
</head>

<body style="margin:0">
    <div id='login' style="width: 275px; height: 135px;vertical-align: middle; display:table;margin: auto; margin-top: 250px; padding:10px;">
        <form id="form">
            <div style="margin: 5px;">
                <h2>Clarity Desktop Login</h2>
                <label style="margin-right: 5px;">Username  </label>
                <input style="float:right;" id="username" type="text" placeholder="GDSXProd\User.Name" name="username" required/>
            </div>
            <div style="margin: 5px;">
                <label style="margin-right: 5px;">Password</label>
                <input style="float:right;" id="password" type="password" placeholder="Enter Password" name="password" required/>
            </div>
            <div style="margin: 5px;">
                <button style="float:right;" type='submit' id='submit' value='submit'>Login</button>
            </div>
        </form>
        <div id='loading' style='display:none;'>
            <h2>Loading...</h2>
        </div>
    </div>
    <div id='error' style="display:none;"></div>
    <div id='menu' style='display:none;'>
        <div style="height: 80px;background: #000; color:white;">
            <h1 style="padding-left: 20px; margin: 0;">Clarity tasks: </h1>
            <span id='allLink' style="padding-left: 20px;">(all)</span><span id="refresh" style="float: right;padding-right:  10px;">â†º</span>
        </div>
        <div id='openedMenu' style="padding-left:20px;height:100%;overflow:scroll;">
            <div id="contents" style="padding-bottom:80px;">Filler-Text</div>
        </div>
    </div>
    <div id='tabs' style='display:none;'>
        <div class="etabs-tabgroup">
            <div class="etabs-tabs"></div>
            <div class="etabs-buttons"></div>
        </div>
        <div class="etabs-views"></div>

        <script>
            const TabGroup = require('electron-tabs')
            let tabGroup = new TabGroup();
        </script>
    </div>
    <script>
        document.getElementById("form").addEventListener('submit', event => {
            event.preventDefault();
            document.getElementById("error").style = "display:none;"
            setup(event)
        });
        async function setup(event) {
            var permaToken = "";
            var response = "";
            var taskData = {
                "Assigned": "",
                "Owned": ""
            }
            let username = document.getElementById("username").value;
            if (username.toLowerCase().includes("gdsxprod") && password != "") {
                let password = document.getElementById("password").value;
                document.getElementById("form").style = 'display:none;';
                document.getElementById("loading").style = 'display:block;';
                if (permaToken == "") {
                    response = await getKeyViaSwagger(username, password, "61");
                    if (response != "Error" && response != "") {
                        permaToken = "Bearer " + response;
                        response = await assignedTasksViaSwagger(username.split("\\")[1], permaToken)
                        if (response != "Error" && response != "") {
                            taskData.Assigned = response;
                            response = await ownedTasksViaSwagger(username.split("\\")[1], permaToken)
                            if (response != "Error" && response != "") {
                                taskData.Owned = response;
                                allTasks(username, permaToken)

                                buildTaskList(taskData, permaToken, username);

                                document.getElementById("login").style = 'display:none;';
                                document.getElementById("menu").style = 'height:100%;width:20%;float:left; vertical-align: top; height: 100%;';
                                document.getElementById("tabs").style = 'width: 80%;height: 100%; float:right;';
                            } else {
                                error("Error getting task Data. Refresh.")
                            }
                        } else {
                            error("Error getting task Data. Refresh.")
                        }
                    } else {
                        error("Error logging in. Try again.")
                    }
                }
            } else {
                error("Format GDSXProd username.")
            }
        }

        function error(error) {
            document.getElementById("form").style = 'display:block;';
            document.getElementById("loading").style = 'display:none;';
            document.getElementById("error").innerHTML = "<p style='color:red;'>" + error + "</p>"
            document.getElementById("error").style = "display:block; width: 275px; vertical-align: middle; display:table; padding:10px;"
        }
    </script>
</body>

</html>