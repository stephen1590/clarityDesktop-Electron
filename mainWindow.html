<html lang="en">

<head>
    <title>Clarity Wrapper</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="tabs.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #c6c6c6;
        }
        
        h1,
        h2,
        h3 {
            font-family: 'Segoe UI Light', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        h2,
        h3 {
            text-align: center;
        }
        
        h3 {
            margin: 0px;
        }
        
        .task {
            padding: 10px 0;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        
        .task:hover {
            background-color: #3c3c3c;
        }
        
        #login {
            background-color: #3c3c3c;
            border-radius: 15px;
        }
    </style>
</head>

<body style="margin:0">
    <div id='login' style="width: 275px; height: 135px;vertical-align: middle; display:table;margin: auto; margin-top: 250px; padding:10px;">
        <div style="margin: 5px;">
            <h2>Clarity Desktop Login</h2>
            <label style="margin-right: 5px;">Username  </label>
            <input style="float:right;" id="username" type="text" placeholder="GDSXProd\User.Name" name="username" required/>
        </div>
        <div style="margin: 5px;">
            <label style="margin-right: 5px;">Password</label>
            <input style="float:right;" id="password" type="password" placeholder="Enter Password" name="password" required/>
        </div>
        <div style="margin: 5px;">
            <button style="float:right;" id='submit'>Login</button>
        </div>
    </div>
    <div id='menu' style='display:none;'>
        <div id='closedMenu'> </div>
        <div id='openedMenu' style="padding-left:20px;">
            <h1>Clarity tasks:</h1>
            <div id="contents">Filler-Text</div>
        </div>
    </div>
    <div id='tabs' style='display:none;'>
        <div class="etabs-tabgroup">
            <div class="etabs-tabs"></div>
            <div class="etabs-buttons"></div>
        </div>
        <div class="etabs-views"></div>

        <script>
            const TabGroup = require('electron-tabs')
            let tabGroup = new TabGroup();
        </script>
    </div>
    <script>
        var permaToken = ""
        var taskData = null
        document.querySelector('#submit').addEventListener('click', async function(event) {
            let username = document.getElementById("username").value;
            if (username.toLowerCase().includes("gdsxprod") && password != "") {
                let password = document.getElementById("password").value;
                document.getElementById("login").innerHTML = "<h2>Loading...</h2>"

                if (permaToken == "") {
                    permaToken = await getKeyViaSwagger(username, password, "61");
                    permaToken = "Bearer " + permaToken;
                }
                if (permaToken != "") {
                    taskData = await tasksViaSwagger(username.split("\\")[1], permaToken)
                }
                document.getElementById("login").style = 'display:none;';
                event.preventDefault();
                buildTaskList(taskData, permaToken);
                document.getElementById("menu").style = 'overflow;hidden;width:25%;float:left; vertical-align: top; height: 100%;';
                document.getElementById("tabs").style = 'width: 75%;height: 100%; float:right;';
            }
        });
    </script>
    <script>
        const uri = "https://clarityapi.concurcompleat.com/swagger";
        const SwaggerClient = require("swagger-client");

        function getKeyViaSwagger(un, pw, cu) {
            return new Promise(resolve => {
                setTimeout(() => {
                    new SwaggerClient({
                            url: uri,
                            usePromise: true
                        })
                        .then(function(client) {
                            client.apis.default.login({
                                    user: un,
                                    pass: pw,
                                    cust: cu
                                })
                                .then(function(login) {
                                    resolve(login.body["Token"]);
                                })
                                .catch(function(error) {
                                    console.log('Oops!  failed with message: ' + error.statusText);
                                });
                        });
                }, 1000);
            });
        }

        function tasksViaSwagger(un, token) {
            return new Promise(resolve => {
                setTimeout(() => {
                    new SwaggerClient({
                            url: uri,
                            usePromise: true,
                            authorizations: {
                                clarity_auth: token
                            }
                        })
                        .then(function(client) {
                            client.apis.default.getTasks({
                                    assignee: [
                                        un
                                    ],
                                    status: [
                                        "1",
                                        "2",
                                        "3",
                                        "4",
                                        "5",
                                        "6"
                                    ]
                                }, )
                                .then(function(tasks) {
                                    resolve(tasks.body);
                                })
                                .catch(function(error) {
                                    console.log('Oops!  failed with message: ' + error.statusText);
                                });
                        });
                }, 1000);
            });
        }

        function buildTaskList(tasksJson, token) {
            const uri = "https://support.concurcompleat.com/task/";
            var htmlItems = "";
            tasksJson.forEach(element => {
                var current = "<div class='task' id='" + element["id"] + "'>";
                //console.log(element);
                current = current + "<span style='white-space: nowrap;'><h3 style='display:inline-block;'>CT#" + element["id"] + "</h3>";
                current = current + " - " + element["title"] + "</span></div>";
                htmlItems = htmlItems + current
            });
            document.getElementById("contents").innerHTML = htmlItems;
            //Now Assign our Events!
            (document.querySelectorAll(".task")).forEach(function(node) {
                node.addEventListener('click', function(event) {
                    addTab(uri, node.id, token);
                })
            });
        }

        function addTab(uri, id, token) {
            uri = uri + id
            var options = {
                title: "CT#" + id,
                src: uri,
                visible: true,
                active: true
            }
            if (tabGroup.tabs.length == 0) {
                options.webviewAttributes = {
                    extraHeaders: "Authorization: " + token
                }
            }
            let tab = tabGroup.addTab(options);
        }
    </script>
</body>

</html>